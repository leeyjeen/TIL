# HTTP/2.0

## HTTP/2.0의 등장 배경

HTTP/1.1의 메시지 포맷은 구현의 단순성과 접근성에 주안점을 두고 최적화됨으로써 성능 문제가 있다. HTTP의 메시지 교환 방식은 응잡을 받아야만 다음 요청을 보낼 수 있기 때문에 심각한 회전 지연(latency)을 피할 수 없었다. 2009년 구글은 웹을 더 빠르게 하겠다는 목표 아래 SPDY 프로토콜을 내놓았다. SPDY 프로토콜은 기존의 HTTP에 속도를 개선하기 위한 여러 기능을 추가한 것이다. SPDY는 헤더를 압축하여 대역폭을 절약했고, 하나의 TCP 커넥션에 여러 요청을 동시에 보내 회전 지연을 줄이는 것이 가능하며, 클라이언트가 요청을 보내지 않아도 서버가 능동적으로 리소스를 푸시하는 기능도 갖추고 있다.

2021년 10월, HTTP 작업 그룹은 SPDY를 기반으로 HTTP/2.0 프로토콜을 설계하기로 결정하였음을 메일링 리스트를 통해 밝혔다.

## 개요

* HTTP/2.0은 서버와 클라이언트 사이의 TCP 커넥션 위에서 동작한다. 이때 TCP 커넥션을 초기화하는 것은 클라이언트다.

* HTTP/2.0 요청과 응답은 길이가 정의된 한 개 이상의 프레임에 담긴다. 이때 HTTP 헤더는 압축되어 담긴다.

* 프레임들에 담긴 요청과 응답은 스트림을 통해 보내진다. 한 개의 스트림이 한 쌍의 요청과 응답을 처리한다. 하나의 커넥션 위에 여러 개의 스트림이 동시에 만들어질 수 있으므로, 여러 개의 요청과 응답을 동시에 처리하는 것이 가능하다. 스트림에 대한 흐름 제어와 우선 순위 부여도 가능하다.

* 새로운 상호작용 모델인 서버 푸시를 도입하여 서버는 클라이언트에게 필요하다고 생각하는 리소스라면 요청을 받지 않더라도 클라이언트에게 보내줄 수 있다.

## HTTP/1.1과의 차이점

### 프레임

HTTP/2.0에서 모든 메시지는 프레임에 담겨 전송된다.

* 8바이트 크기의 **헤더**
  * R: 예약된 2비트 필드. 반드시 0이어야 한다.
  * 길이: 페이로드의 길이를 나타내는 14비트 unsigned integer. 이 길이에 프레임 헤더는 포함되지 않는다.
  * 종류: 프레임의 종류
  * 플래그: 8비트. 플래그 값의 의미는 프레임의 종류에 따라 다르다.
  * R: 예약된 1비트 필드. 반드시 0이어야 한다. 
  * 스트림 식별자: 31비트 스트림 식별자. 특별히 0은 커넥션 전체와 연관된 프레임임을 의미한다.
* 최대 16383 바이트 크기의 **페이로드**

### 스트림과 멀티플렉싱

* 스트림
  * HTTP/2.0 커넥션을 통해 클라이언트와 서버 사이에서 교환되는 프레임들의 독립된 양방향 시퀀스
  * 한 쌍의 HTTP 요청과 응답은 하나의 스트림을 통해 이루어진다.
  * cf. HTTP/1.1에서는 회전 지연을 줄이기 위해 여러 개의 TCP 커넥션을 만들어 동시에 여러 개의 요청을 만드는 방법을 사용한다.
  * HTTP/2.0에서는 하나의 커넥션에 여러 개의 스트림이 동시에 열릴 수 있다.
  * 우선순위를 가질 수 있다.
  * 서버와 클라이언트는 스트림을 상대방과 협상 없이 일방적으로 만듬으로써 시간을 낭비하지 않는다.
  * 한번 사용한 스트림 식별자는 다시 사용할 수 없다.

### 헤더 압축

요즘 웹페이지 하나를 보기 위해 수십 수백 번의 요청을 보내기 때문에, 헤더의 크기가 회전 지연과 대역폭 양쪽 모두에 영향을 끼치게 되었다.

이를 개선하기 위해 HTTP/2.0에서는 HTTP 메시지의 헤더를 압축하여 전송한다. HPACK 명세에 정의된 헤더 압축 방법으로 압축된 뒤 '헤더 블록 조각'들로 쪼개져서 전송된다. 받는 쪽에서는 조각을 이은 뒤 압축을 풀어 원래의 헤더 집합으로 복원한다.

### 서버 푸시

HTTP/2.0은 서버가 하나의 요청에 대해 응답으로 여러 개의 리소스를 보낼 수 있도록 해준다. 이는 서버가 클라이언트에서 어떤 리소스를 요구할 것인지 미리 알 수 있는 상황에서 유용하다.

1. 리소스를 푸시하려는 서버는 클라이언트에게 자원을 푸시할 것임을 **PUSH_PROMISE** 프레임을 보내어 미리 알려주어야 한다. 
2. 클라이언트가 수신시 해당 프레임의 스트림은 '예약됨' 상태가 된다.
3. 클라이언트는 **RST_STREAM** 프레임을 보내어 푸시를 거절할 수 있다. 스트림이 닫힌다. 스트림이 닫히기 전까지 클라이언트는 서버가 푸시하려고 하는 리소스를 요청해서는 안된다.

## 알려진 보안 이슈

### 중개자 캡슐화 공격(Intermediary Encapsulation Attacks)

HTTP/2.0 메시지를 중간의 프락시가 HTTP/1.1 메시지로 변환할 때 메시지의 의미가 변질될 수 있다. HTTP/2.0은 헤더 필드의 이름과 값을 바이너리로 인코딩하므로 어떤 문자열이든 헤더 필드로 사용할 수 있게 해준다. 이는 정상적인 HTTP/2.0 요청이나 응답이, 불법적이거나 위조된 HTTP/1.1 메시지로 번역되는 것을 유발할 수 있다. 

### 긴 커넥션 유지로 인한 개인정보 누출 우려

사용자가 요청을 보낼 때의 회전 지연을 줄이기 위해 클라이언트와 서버 사이 커넥션을 오래 유지하므로 개인 정보 유출에 악용될 가능성이 있다.
