# 캐시

웹 캐시는 자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치다. 웹 요청이 캐시에 도착했을 때, 캐시된 로컬 사본이 존재한다면, 그 문서는 원 서버가 아니라 그 캐시로부터 제공된다.

## 불필요한 데이터 전송

복수의 클라이언트가 자주 쓰이는 서버 페이지 접근시, 서버는 같은 문서를 클라이언트들에게 각각 한 번씩 전송하게 된다. 캐시를 이용하면, 첫 번째 서버 응답은 캐시에 보관된다. 캐시된 사본이 뒤이은 요청들에 대한 응답으로 사용될 수 있기 때문에, 서버가 중복해서 트래픽을 주고받는 낭비가 줄어들게 된다.

## 대역폭 병목

캐시는 네트워크 병목을 줄여준다. 클라이언트들이 서버에 접근할 때의 속도는 그 경로에 있는 가장 느린 네트워크의 속도와 같다. 만약 클라이언트가 빠른 LAN에 있는 캐시로부터 사본을 가져온다면, 캐싱은 성능을 대폭 개선할 수 있을 것이다.

## 갑작스런 요청 쇄도(Flash Crowds)

캐싱은 갑작스런 요청 쇄도에 대처하기 위해 중요하다. 트래픽 급증은 네트워크와 웹 서버의 심각한 장애를 야기시킨다. 

## 거리로 인한 지연

모든 네트워크 라우터는 인터넷 트래픽을 지연시킨다. 클라이언트와 서버 사이에 라우터가 많지 않더라도, 빛의 속도 그 자체가 유의미한 지연을 유발한다. 기계실 근처에 캐시를 설치해서 문서가 전송되는 거리를 수천 킬로미터에서 수십 미터로 줄일 수 있다.

## 적중과 부적중

캐시가 세상 모든 문서의 사본을 저장하지는 않는다.

* 캐시 적중(cache hit): 캐시에 요청이 도착했을 때, 대응하는 사본이 있다면 이를 이용해 요청이 처리될 수 있다.
* 캐시 부적중(cache miss): 캐시에 요청이 도착했을 때, 대응하는 사본이 없다면 서버로 전달되기만 한다.

### 재검사(Revalidation)

서버 콘텐츠는 변경될 수 있기 때문에, 캐시는 반드시 사본이 여전히 최신인지 서버를 통해 때때로 점검해야 한다. 이러한 '신선도 검사'를 HTTP 재검사라 부른다.

캐시는 캐시된 사본의 재검사가 필요할 때, 서버에 작은 재검사 요청을 보낸다. 콘텐츠가 변경되지 않았다면 `304 Not Modified` 응답을 보낸다. 이를 재검사 적중, 느린 적중이라고 부른다.

HTTP는 캐시된 객체를 재확인하기 위한 도구를 제공한다. 서버에 GET 요청시 `If-Modified-Since` 헤더를 추가하면 캐시된 시간 이후에 변경된 경우에만 사본을 보내달라는 의미이다. 

다음은 `GET If-Modified-Since` 요청이 서버 도착시 일어날 수 있는 세 가지 상황이다.
* 재검사 적중
    * 서버 객체 변경되지 않은 경우
    * `HTTP 304 Not Modified` 응답
* 재검사 부적중
    * 서버 객체가 캐시된 사본과 다른 경우
    * 서버는 콘첸츠 전체와 함께 `HTTP 200 OK` 응답
* 객체 삭제
    * 서버 객체가 삭제된 경우
    * `404 Not Found` 응답
    * 캐시는 사본을 삭제

### 적중률

* 캐시 적중률 또는 문서 적중률
    * 캐시가 요청을 처리하는 비율
    * 0~1 또는 퍼센트로 표현되기도 한다.

### 바이트 적중률

문서들이 모두 같은 크기인 것은 아니기 때문에, 문서 적중률이 모든 것을 말해주지는 않는다.

바이트 단위 전중률은 캐시를 통해 제공된 모든 바이트의 비율을 표현한다. 이 측정값은 트래픽이 절감된 정도를 포착해낸다. 바이트 단위 적중률 100%는 모든 바이트가 캐시에서 왔으며, 어떤 트래픽도 인터넷으로 나가지 않았음을 의미한다. 

이러한 적중률은 캐시 성능에 대한 유용한 지표가 된다.

### 적중과 부적중의 구별

HTTP는 클라이언트에게 응답이 캐시 적중이었는지, 서버 접근인지 말해줄 수 있는 방법을 제공하지 않는다.

클라이언트가 응답이 캐시에서 왔는지 알아내는 방법은 `Date` 헤더 또는 `Age` 헤더를 이용하는 것이다.

## 캐시 토폴로지

### 개인 전용 캐시

### 공용 프락시 캐시

### 프락시 캐시 계층들

### 캐시망, 콘텐츠 라우팅, 피어링

## 캐시 처리 단계

### 단계1: 요청 받기

### 단계2: 파싱

### 단계3: 검색

### 단계4: 신선도 검사

### 단계5: 응답 생성

### 단계6: 전송

### 단계7: 로깅

## 사본을 신선하게 유지하기

### 문서 만료

### 유효기간과 나이

### 서버 재검사

### 조건부 메서드와의 재검사

### If-Modified-Since: 날짜 재검사

### If-None-Match: 엔터티 태그 재검사

### 약한 검사기와 강한 검사기

### 언제 엔터티 태그를 사용하고 언제 Last-Modified 일시를 사용하는가

## 캐시 제어

### no-cache와 no-store 응답 헤더

### Max-Age 응답 헤더

### Expires 응답 헤더

### Must-Revalidate 응답 헤더

### 휴리스틱 만료

### 클라이언트 신선도 제약

### 주의할 점

## 자세한 알고리즘

### 나이와 신선도 수명

### 나이 계산

### 완전한 나이 계산 알고리즘

### 신선도 수명 계산

### 완전한 서버 신선도 알고리즘
